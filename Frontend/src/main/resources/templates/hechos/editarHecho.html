<html th:replace="~{layout/base::html}">
<head>
    <th:block th:fragment="styles">
        <link th:href="@{/css/hechos/crearHecho.css}" rel="stylesheet">
    </th:block>
</head>

<main th:fragment="contenido" class="container">
    <section class="form-container">
        <h1>Solicitar Modificación</h1>

        <div class="alert alert-info" style="background-color: #e3f2fd; color: #0d47a1; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #bbdefb;">
            <i class="fas fa-info-circle"></i>
            <strong>Importante:</strong> Estás creando una solicitud de edición. Un administrador revisará tus cambios (Título, Descripción o Categoría) antes de que sean públicos.
        </div>

        <form th:action="@{/hechos/{id}/editar(id=${hechoOutput.id})}"
              th:object="${hecho}"
              method="POST"
              class="form">

            <div class="form-group">
                <label for="titulo">Título</label>
                <input type="text" id="titulo" th:field="*{titulo}"
                       th:classappend="${#fields.hasErrors('titulo')} ? 'input-error' : ''"
                       required>
                <span class="error-mensaje" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></span>
            </div>

            <div class="form-group">
                <label for="categoria">Categoría</label>
                <select id="categoria" th:field="*{idCategoria}"
                        th:classappend="${#fields.hasErrors('idCategoria')} ? 'input-error' : ''">
                    <option value="">Seleccione una categoría</option>
                    <option th:each="cat : ${categorias}"
                            th:value="${cat.id}"
                            th:text="${cat.categoria}"
                            th:selected="${hechoOutput.categoria.equals(cat.categoria)}">
                    </option>
                </select>
                <span class="error-mensaje" th:if="${#fields.hasErrors('idCategoria')}" th:errors="*{idCategoria}"></span>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" th:field="*{descripcion}" rows="6"
                          th:classappend="${#fields.hasErrors('descripcion')} ? 'input-error' : ''"
                          required></textarea>
                <span class="error-mensaje" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></span>
            </div>

            <input type="hidden" th:field="*{fechaAcontecimiento}">
            <input type="hidden" th:field="*{latitud}">
            <input type="hidden" th:field="*{longitud}">

            <div class="submit-container" style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <a th:href="@{/hechos/misHechos}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
            </div>
        </form>
    </section>

    <div th:if="${mensaje}" class="modal-overlay" id="mensajeModal" style="display: flex;"
         th:attr="data-redirect=${tipoMensaje == 'success' ? 'true' : 'false'}">
        <div class="modal-content" th:classappend="${tipoMensaje == 'success' ? 'modal-success' : 'modal-error'}">
            <div class="modal-header">
                <h3 th:text="${tipoMensaje == 'success' ? 'Solicitud Enviada' : 'Error'}"></h3>
            </div>
            <div class="modal-body">
                <p th:text="${mensaje}"></p>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="cerrarModalYRedirigir()" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
</main>

<th:block th:fragment="scripts">
    <script>
        function cerrarModalYRedirigir() {
            const modal = document.getElementById('mensajeModal');
            if (modal.dataset.redirect === 'true') {
                window.location.href = '/hechos/misHechos';
            } else {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('mensajeModal');
            // Si el modal existe (porque hay mensaje del backend), asegúrate que se vea
            if(modal) modal.style.display = 'flex';
        });
    </script>
</th:block>

</html>